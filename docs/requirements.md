# АС "Судоперевозки" - Требования

## 1. Функциональные требования

### FR-AUTH: Аутентификация
- **FR-AUTH-01**: Система должна обеспечивать вход через email/пароль
- **FR-AUTH-02**: Система должна поддерживать обновление сессий (сохранение входа при перезагрузке страницы)
- **FR-AUTH-03**: Система должна поддерживать изменение пароля пользователем

### FR-USER: Управление пользователями
- **FR-USER-01**: Администратор должен иметь возможность создавать пользователей
- **FR-USER-02**: Администратор должен иметь возможность изменять роли пользователей
- **FR-USER-03**: Администратор должен иметь возможность деактивировать пользователей

### FR-ROUTE: Управление маршрутами
- **FR-ROUTE-01**: Пользователи с ролью диспетчер/администратор должны иметь возможность создавать маршруты
- **FR-ROUTE-02**: Маршрут должен содержать минимум 2 остановки (начало, конец)
- **FR-ROUTE-03**: Каждая остановка должна иметь адрес и порядковый номер
- **FR-ROUTE-04**: Пользователи должны иметь возможность просматривать список маршрутов
- **FR-ROUTE-05**: Пользователи должны иметь возможность искать/фильтровать маршруты
- **FR-ROUTE-06**: Пользователи должны иметь возможность отменять маршруты (статус: отменён)

### FR-AUDIT: Аудит
- **FR-AUDIT-01**: Система должна хранить создателя маршрута и временные метки создания/обновления
- **FR-AUDIT-02**: Система должна логировать ключевые действия (вход, создание маршрута, обновление маршрута, отмена маршрута)

## 2. Нефункциональные требования

- **NFR-01**: API только через HTTPS (HTTP в режиме разработки)
- **NFR-02**: Валидация входных данных на backend (Pydantic)
- **NFR-03**: Обработка ошибок с единым форматом ответа
- **NFR-04**: Производительность - список маршрутов должен возвращаться с пагинацией (limit/offset)
- **NFR-05**: Безопасность - пароли только в хешированном виде (bcrypt)
- **NFR-06**: Наблюдаемость (минимум): структурированные логи + healthcheck
- **NFR-07**: Документация - OpenAPI доступна (/docs)

## 3. Бизнес-правила

- **BR-01**: Маршрут должен иметь минимум 2 остановки
- **BR-02**: Порядковые номера остановок должны быть непрерывными и уникальными в пределах маршрута
- **BR-03**: Нельзя перейти в статус 'активен' без начальной и конечной остановки
- **BR-04**: Отменённый маршрут не может быть отредактирован (кроме комментария по решению)
- **BR-05**: Наблюдатель не может создавать/редактировать маршруты

## 4. Роли и права доступа (RBAC)

| Действие | Администратор | Диспетчер | Наблюдатель |
|--------|-------|------------|--------|
| Создание/Редактирование пользователей | ✓ | ✗ | ✗ |
| Создание маршрутов | ✓ | ✓ | ✗ |
| Редактирование маршрутов | ✓ | ✓ | ✗ |
| Отмена маршрутов | ✓ | ✓ | ✗ |
| Просмотр маршрутов | ✓ | ✓ | ✓ |

## 5. Модель данных

### Таблица Users (Пользователи)
| Колонка | Тип | Ограничения |
|--------|------|-------------|
| id | UUID | PK |
| email | VARCHAR(255) | UNIQUE, NOT NULL |
| full_name | VARCHAR(255) | NOT NULL |
| password_hash | VARCHAR(255) | NOT NULL |
| role | ENUM | admin/dispatcher/viewer |
| is_active | BOOLEAN | DEFAULT true |
| must_change_password | BOOLEAN | DEFAULT true |
| created_at | TIMESTAMP | NOT NULL |
| updated_at | TIMESTAMP | NOT NULL |

### Таблица Routes (Маршруты)
| Колонка | Тип | Ограничения |
|--------|------|-------------|
| id | UUID | PK |
| route_number | VARCHAR(50) | UNIQUE, NOT NULL |
| title | VARCHAR(255) | NOT NULL |
| status | ENUM | draft/active/completed/cancelled |
| created_by | UUID | FK -> users.id |
| planned_departure_at | TIMESTAMP | NULLABLE |
| comment | TEXT | NULLABLE |
| created_at | TIMESTAMP | NOT NULL |
| updated_at | TIMESTAMP | NOT NULL |

### Таблица Route Stops (Остановки маршрута)
| Колонка | Тип | Ограничения |
|--------|------|-------------|
| id | UUID | PK |
| route_id | UUID | FK -> routes.id (CASCADE) |
| seq | INTEGER | NOT NULL |
| type | ENUM | origin/stop/destination |
| address | TEXT | NOT NULL |
| lat | NUMERIC(10,8) | NULLABLE |
| lng | NUMERIC(11,8) | NULLABLE |
| time_window_from | TIMESTAMP | NULLABLE |
| time_window_to | TIMESTAMP | NULLABLE |
| contact_name | VARCHAR(255) | NULLABLE |
| contact_phone | VARCHAR(50) | NULLABLE |
| created_at | TIMESTAMP | NOT NULL |

## 6. Переходы статусов

```
ЧЕРНОВИК -> АКТИВЕН -> ЗАВЕРШЁН
     |         |
     v         v
 ОТМЕНЁН   ОТМЕНЁН
```

- Черновик: Начальное состояние, редактируемый
- Активен: В процессе, остановки не могут быть изменены
- Завершён: Завершён, только для чтения
- Отменён: Отменён, только для чтения

## 7. Критерии приёмки

1. ✓ Пользователь может войти в систему
2. ✓ Администратор может создать пользователя и назначить роль
3. ✓ Диспетчер может создать маршрут минимум с 2 остановками
4. ✓ Маршрут отображается в списке и открывается в детальном просмотре
5. ✓ Доступна фильтрация/поиск по запросу и статусу
6. ✓ Маршрут может быть отменён
7. ✓ Данные сохраняются в PostgreSQL после перезапуска
